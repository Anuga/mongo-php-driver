<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">

	<title>Object Document Serialization - PHongo: The MongoDB Driver for PHP</title>

        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <link href="../css/base.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="..">PHongo: The MongoDB Driver for PHP</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="..">Home</a>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">CRUD <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../crud/">Basic</a>
                        </li>
                    
                        <li >
                            <a href="../bulk/">Bulks</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li >
                    <a href="../commands/">Commands</a>
                </li>
            
            
            
                <li class="active">
                    <a href="./">Object Document Serialization</a>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                <li >
                    <a rel="next" href="../commands/">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li class="disabled">
                    <a rel="prev" >
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
                <li>
                    <a href="https://github.com/mongodb/mongo-php-driver">
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#object-serialization">Object serialization</a></li>
        
            <li><a href="#examples">Examples</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h1 id="object-serialization">Object serialization</h1>
<p>This driver includes four public interfaces to facilitate serializing PHP
classes to and from BSON.</p>
<ul>
<li>MongoDB\BSON\Type<ul>
<li>(no methods)</li>
</ul>
</li>
<li>MongoDB\BSON\Serializable<ul>
<li>abstract public method bsonSerialize();</li>
</ul>
</li>
<li>MongoDB\BSON\Unserializable<ul>
<li>abstract public method bsonUnserialize(array $data);</li>
</ul>
</li>
<li>MongoDB\BSON\Persistable<ul>
<li>extends both BSON\Serializable and BSON\Unserializable</li>
</ul>
</li>
</ul>
<p>Objects that implement the MongoDB\BSON\Type interface get special treatment by
the BSON serializer. In general, these objects represent a BSON type that cannot
be natively represented in PHP (e.g. MongoDB\BSON\UTCDatetime,
MongoDB\BSON\ObjectID) and are explicitly checked for and handled by the driver.
MongoDB\BSON\Type should not be implemented directly by userland classes.</p>
<p>Userland classes that require custom BSON serialization should utilize the
MongoDB\BSON\Serializable interface and implement the <code>bsonSerialize()</code>
function, which should return a document (i.e. PHP array or stdClass object)
representing the document that should be stored. Furthermore, if the object
implements the MongoDB\BSON\Persistable interface, the driver will also inject a
MongoDB\BSON\Binary value (with type 0x80 and an internal field name) into the
document, which contains the userland object's fully qualified classname. This
field can then be used during unserialization to ensure that the BSON document
becomes an object of the same class on the way out of the database.</p>
<p>During unserialization of a document, if a BSON Binary value (with type 0x80 and
within the expected internal field name) is encountered, the driver will peek at
the value and attempt to resolve it to a classname (triggering autoloaders if
neccesary). If the class name cannot be resolved, nothing magical happens;
however, if the class exists, the driver will create a new instance (without
invoking the constructor) and invoke its <code>bsonUnserialize()</code> method, supplying
the unserialized document data as a PHP array. Note that this happens
depth-first, which means that embedded documents will be resolved before their
parent.</p>
<h2 id="examples">Examples</h2>
<p>Consider the following two classes: Person and Address. A Person has name, age,
friends (array of Person objects), and addresses (array of Address objects). A
Person also has a secret, that we would rather not store in a database.</p>
<pre><code>&lt;?php

class Person implements MongoDB\BSON\Persistable
{
    protected $_id;
    protected $name;
    protected $age;
    protected $address = [];
    protected $friends = [];
    protected $secret = &quot;none&quot;;

    function __construct($name, $age)
    {
        $this-&gt;name    = $name;
        $this-&gt;age     = $age;
        $this-&gt;address = [];
        $this-&gt;secret  = &quot;$name confidential info&quot;;
        /* Pregenerate our ObjectID */
        $this-&gt;_id     = new MongoDB\BSON\ObjectID();
    }

    function addAddress(Address $address)
    {
        $this-&gt;address[] = $address;
    }

    function addFriend(Person $friend)
    {
        $this-&gt;friends[] = $friend;
    }

    function bsonSerialize()
    {
        return [
            &quot;_id&quot;     =&gt; $this-&gt;_id,
            &quot;name&quot;    =&gt; $this-&gt;name,
            &quot;age&quot;     =&gt; $this-&gt;age,
            &quot;address&quot; =&gt; $this-&gt;address,
            &quot;friends&quot; =&gt; $this-&gt;friends,
        ];
    }

    function bsonUnserialize(array $data)
    {
        $this-&gt;_id     = $data[&quot;_id&quot;];
        $this-&gt;name    = $data[&quot;name&quot;];
        $this-&gt;age     = $data[&quot;age&quot;];
        $this-&gt;address = $data[&quot;address&quot;];
        $this-&gt;friends = $data[&quot;friends&quot;];
    }
}

class Address implements MongoDB\BSON\Persistable
{
    protected $zip;
    protected $country;

    function __construct($zip, $country)
    {
        $this-&gt;zip = $zip;
        $this-&gt;country = $country;
    }

    function bsonSerialize()
    {
        return [
            &quot;zip&quot;     =&gt; $this-&gt;zip,
            &quot;country&quot; =&gt; $this-&gt;country,
        ];
    }

    function bsonUnserialize(array $data)
    {
        $this-&gt;zip = $data[&quot;zip&quot;];
        $this-&gt;country = $data[&quot;country&quot;];
    }
}

?&gt;
</code></pre>

<p>Hannes is 31 years old and has two addresses;</p>
<ul>
<li>Sunnyvale, USA</li>
<li>Kopavogur, Iceland</li>
</ul>
<p>He is friends with young Jeremy, a 21 year old who lives in Michigan:</p>
<pre><code>&lt;?php
$hannes = new Person(&quot;Hannes&quot;, 31);
$sunnyvale = new Address(94086, &quot;USA&quot;);
$kopavogur = new Address(200, &quot;Iceland&quot;);
$hannes-&gt;addAddress($sunnyvale);
$hannes-&gt;addAddress($kopavogur);

$mikola = new Person(&quot;Jeremy&quot;, 21);
$michigan = new Address(48169, &quot;USA&quot;);
$mikola-&gt;addAddress($michigan);

$hannes-&gt;addFriend($mikola);

?&gt;
</code></pre>

<p>To save this information, we can insert <code>$hannes</code> into the database like so:</p>
<pre><code>&lt;?php
try {
    $wc = new MongoDB\Driver\WriteConcern(MongoDB\Driver\WriteConcern::MAJORITY);
    $manager = new MongoDB\Driver\Manager(&quot;mongodb://192.168.112.10:2000&quot;);
    $result = $manager-&gt;executeInsert(&quot;congress.people&quot;, $hannes, $wc);
    echo &quot;Hannes has been inserted\n&quot;;
} catch(Exception $e) {
    echo $e-&gt;getMessage(), &quot;\n&quot;;
    exit;
}
?&gt;
</code></pre>

<p>This will result in the following document stored (as shown by mongo shell):</p>
<pre><code>{
  &quot;_id&quot; : ObjectId(&quot;551f2004bd21b959de3c15b1&quot;),
  &quot;__pclass&quot; : BinData(128,&quot;UGVyc29u&quot;),
  &quot;name&quot; : &quot;Hannes&quot;,
  &quot;age&quot; : 31,
  &quot;address&quot; : [
    {
      &quot;__pclass&quot; : BinData(128,&quot;QWRkcmVzcw==&quot;),
      &quot;zip&quot; : 94086,
      &quot;country&quot; : &quot;USA&quot;
    },
    {
      &quot;__pclass&quot; : BinData(128,&quot;QWRkcmVzcw==&quot;),
      &quot;zip&quot; : 200,
      &quot;country&quot; : &quot;Iceland&quot;
    }
  ],
  &quot;friends&quot; : [
    {
      &quot;__pclass&quot; : BinData(128,&quot;UGVyc29u&quot;),
      &quot;_id&quot; : ObjectId(&quot;551f2004bd21b959de3c15b2&quot;),
      &quot;name&quot; : &quot;Jeremy&quot;,
      &quot;age&quot; : 21,
      &quot;address&quot; : [
        {
          &quot;__pclass&quot; : BinData(128,&quot;QWRkcmVzcw==&quot;),
          &quot;zip&quot; : 48169,
          &quot;country&quot; : &quot;USA&quot;
        }
      ],
      &quot;friends&quot; : {

      }
    }
  ]
}
</code></pre>

<p>When we read this document back, the driver will convert the individual
sub-documents back into their original classes, as we have full type information
for them now:</p>
<pre><code>&lt;?php

$rp = new MongoDB\Driver\ReadPreference(MongoDB\Driver\ReadPreference::RP_PRIMARY_PREFERRED);
$query = new MongoDB\Driver\Query([]);
$cursor = $manager-&gt;executeQuery(&quot;congress.people&quot;, $query, $rp);

foreach($cursor as $person) {
    var_dump($person);
}

?&gt;
</code></pre>

<p>This results in:</p>
<pre><code>object(Person)#22 (6) {
  [&quot;_id&quot;:protected]=&gt;
  object(BSON\ObjectID)#15 (0) {
  }
  [&quot;name&quot;:protected]=&gt;
  string(6) &quot;Hannes&quot;
  [&quot;age&quot;:protected]=&gt;
  int(31)
  [&quot;address&quot;:protected]=&gt;
  array(2) {
    [0]=&gt;
    object(Address)#16 (2) {
      [&quot;zip&quot;:protected]=&gt;
      int(94086)
      [&quot;country&quot;:protected]=&gt;
      string(3) &quot;USA&quot;
    }
    [1]=&gt;
    object(Address)#17 (2) {
      [&quot;zip&quot;:protected]=&gt;
      int(200)
      [&quot;country&quot;:protected]=&gt;
      string(7) &quot;Iceland&quot;
    }
  }
  [&quot;friends&quot;:protected]=&gt;
  array(1) {
    [0]=&gt;
    object(Person)#21 (6) {
      [&quot;_id&quot;:protected]=&gt;
      object(BSON\ObjectID)#18 (0) {
      }
      [&quot;name&quot;:protected]=&gt;
      string(6) &quot;Jeremy&quot;
      [&quot;age&quot;:protected]=&gt;
      int(21)
      [&quot;address&quot;:protected]=&gt;
      array(1) {
        [0]=&gt;
        object(Address)#19 (2) {
          [&quot;zip&quot;:protected]=&gt;
          int(48169)
          [&quot;country&quot;:protected]=&gt;
          string(3) &quot;USA&quot;
        }
      }
      [&quot;friends&quot;:protected]=&gt;
      object(stdClass)#20 (0) {
      }
      [&quot;secret&quot;:protected]=&gt;
      string(4) &quot;none&quot;
    }
  }
  [&quot;secret&quot;:protected]=&gt;
  string(4) &quot;none&quot;
}
</code></pre></div>
        </div>

        <footer class="col-md-12">
            <hr>
            
            <center>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</center>
        </footer>

        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
        <script src="../js/base.js"></script>
        <script src="../pretty.js"></script>
        <script src="../jira.js"></script>
    </body>
</html>